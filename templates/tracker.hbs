<div class="nimble-tracker-container">
    {{#if isGM}}
        <div class="gm-header">
            <div class="header-title">Nimble Tracker</div>
            {{#if combatActive}}
                <button class="end-combat icon-btn end-combat-glow" data-action="endCombat" style="width: 32px; height: 32px;" title="End Combat">
                    <i class="fas fa-stop"></i>
                </button>
                <button class="new-round icon-btn" data-action="newRound" style="width: 32px; height: 32px; margin-left: 8px;" title="New Round">
                    <i class="fas fa-fast-forward"></i>
                </button>
            {{else}}
                <button class="request-init icon-btn" data-action="requestInit" style="width: 32px; height: 32px;" title="Initiative">
                    <i class="fas fa-dice-d20"></i>
                </button>
            {{/if}}
        </div>

        {{#each players}}
            <div class="player-row modern" data-actor-id="{{this.id}}">
                <div class="row-top" style="position: relative;">
                    <span class="player-name">{{this.name}}</span>
                    {{#unless (eq ../initiativeType "standard")}}
                        <span class="readiness-tag readiness-top-right {{this.readiness}}">{{#if this.readiness}}[{{this.readiness}}]{{/if}}</span>
                    {{/unless}}
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%;">
                    <div class="pip-container" id="pips-{{this.id}}">
                        <span class="loading-text">Calculating...</span>
                        {{#each this.pips}}
                            <div class="pip {{this.type}} {{#if this.active}}active{{/if}}" data-index="{{@index}}"></div>
                        {{/each}}
                    </div>
                    <span style="display: flex; gap: 4px; align-items: center;">
                        <button class="fill-row-pips icon-btn" data-action="fillPips" style="width: 32px; height: 32px; font-size: 14px; align-self: center;" title="Refill Pips">
                            <i class="fas fa-sync"></i>
                        </button>
                        <button class="toggle-token-ring icon-btn" data-action="toggleTokenRing" style="width: 32px; height: 32px; font-size: 14px; align-self: center;" title="Toggle Turn">
                            <i class="fas fa-circle"></i>
                        </button>
                    </span>
                </div>
            </div>
        {{/each}}

        <hr style="border: none; border-top: 2px solid #444; margin: 0px 0;" />

        <div class="npc-row-list" style="display: flex; flex-direction: column; gap: 8px;">
            {{#each npcs}}
                <div class="npc-row" data-token-id="{{this.tokenId}}">
                    <span class="npc-name">{{this.name}}</span>
                     <span style="display: flex; gap: 4px; align-items: center;">
                        <button class="toggle-dead-state icon-btn" data-action="toggleDeadState" style="width: 32px; height: 32px; font-size: 14px; align-self: center;" title="Toggle Death">
                            <i class="fas fa-skull"></i>
                        </button>
                        <button class="toggle-npc-ring icon-btn" data-action="toggleNpcRing" title="Toggle Turn">
                            <i class="fas fa-circle"></i>
                        </button>
                    </span>

                </div>
            {{/each}}
        </div>
    {{else}}
        <div class="player-row modern" data-actor-id="{{player.id}}" style="border-bottom: none;">
            <div class="row-top" style="display: flex; justify-content: space-between; align-items: center;">
                <span class="player-name">{{player.name}}</span>
                {{#unless (eq initiativeType "standard")}}
                    <span class="readiness-tag {{player.readiness}}">{{#if player.readiness}}[{{player.readiness}}]{{/if}}</span>
                {{/unless}}
            </div>
            {{#if (eq initiativeType "standard")}}
                {{#unless (or player.pips.[0].active player.pips.[1].active player.pips.[2].active)}}
                    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 8px;">
                        <button class="roll-init icon-btn flashy-dice" data-action="rollInit" style="width: 48px; height: 48px; font-size: 24px; animation: dice-flash 1s infinite alternate; box-shadow: 0 0 16px #f1c40f; border-color: #f1c40f;" title="Roll Readiness">
                            <i class="fas fa-dice-d20"></i>
                        </button>
                        <span style="margin: 8px 0 4px 0; font-weight: bold; color: #888;">OR</span>
                        <input type="number" min="1" max="30" class="manual-readiness-input" placeholder="manual roll" style="width: 8rem; text-align: center; font-size: 1.1rem; padding: 0.25rem 0.5rem; border-radius: 0.3rem; border: 1px solid #ccc; color: #fff; background: transparent;" />
                    </div>
                {{/unless}}
            {{else}}
                {{#unless player.readiness}}
                <div style="display: flex; flex-direction: column; align-items: center; margin-top: 8px;">
                    <button class="roll-init icon-btn flashy-dice" data-action="rollInit" style="width: 48px; height: 48px; font-size: 24px; animation: dice-flash 1s infinite alternate; box-shadow: 0 0 16px #f1c40f; border-color: #f1c40f;" title="Roll Readiness">
                        <i class="fas fa-dice-d20"></i>
                    </button>
                    <span style="margin: 8px 0 4px 0; font-weight: bold; color: #888;">OR</span>
                    <input type="number" min="1" max="30" class="manual-readiness-input" placeholder="manual roll" style="width: 8rem; text-align: center; font-size: 1.1rem; padding: 0.25rem 0.5rem; border-radius: 0.3rem; border: 1px solid #ccc; color: #fff; background: transparent;" />
                </div>
                {{/unless}}
            {{/if}}
            <div class="pip-container" id="pips-{{player.id}}" style="margin-top: 8px; justify-content: center;">
                <span class="loading-text">Calculating...</span>
                {{#if (eq initiativeType "standard")}}
                    {{#if (or player.pips.[0].active player.pips.[1].active player.pips.[2].active)}}
                        {{#each player.pips}}
                            <div class="pip {{this.type}} {{#if this.active}}active{{/if}}" data-index="{{@index}}"></div>
                        {{/each}}
                    {{/if}}
                {{else}}
                    {{#if player.readiness}}
                        {{#each player.pips}}
                            <div class="pip {{this.type}} {{#if this.active}}active{{/if}}" data-index="{{@index}}"></div>
                        {{/each}}
                    {{/if}}
                {{/if}}
            </div>
        </div>
    {{/if}}
</div>